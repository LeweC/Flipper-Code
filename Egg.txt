+--------------------------------------------------------------------+
| PHASE I 	HOME
| PHASE II 	IN POSITION
| PHASE III GRAB	
| PHASE IV	RELEASE
+--------------------------------------------------------------------+

+--------------------------------------------------------------------+
|	Setup
|	XL430 		--> flex/extend fingers
|	XL330 ID 1	--> flex/extend thumb
|	XL330 ID 2	--> rotate fingers
|
+--------------------------------------------------------------------+

#INIT
	do
		2 -->xNUM
		1 2 -->xENABLE
		1 -->ENABLE
		2 xANGLE -->oldAngle
		UpdateValues!
		0 FingerToMotorAngle 2 = -->REDLED
;

+--------------------------------------------------------------------+
| PHASE I 	HOME
+--------------------------------------------------------------------+

#HOME_ROTATE_FINGERS
	after 
		INIT
	do 
		Rotate
	until 
		STOP_REACHED_FR
;

#HOME_EXTEND_THUMB
	do 
		ExtendThumb
	until 
		STOP_REACHED_TE
;

#HOME_EXTEND_FINGERS
	after 
		
	do 
		
	until 
		STOP_REACHED_FE
;

#READY 
	after 
		HOME_ROTATE_FINGERS
	do 
		0 2 -->xMOTOR
;

+--------------------------------------------------------------------+
| PHASE II 	IN POSITION
|  0 RotatePosition Fingers and Thumb are parallel 
| 90 RotatePosition Fingers and Thumb are orthogonal
+--------------------------------------------------------------------+

#FINGER_IN_POSITION
	after
		READY
	do
		1000 RotatePosition
		FlexPosition
;

+--------------------------------------------------------------------+
| PHASE III GRAB	
+--------------------------------------------------------------------+
#GRAB
;

+--------------------------------------------------------------------+
|
+--------------------------------------------------------------------+
:UpdateValues
	oldAngle 2 xANGLE - -->diffAngle
	lap diffAngle 1000 > + -->lap
	lap diffAngle -1000 < - -->lap
	2 xANGLE -->oldAngle
;

:Rotate
	1 -->motorDirection 
	50 -->motorSpeed
	motorDirection motorSpeed * 2 -->xMOTOR
;

:STOP_REACHED_FR
	counter 1 + -->counter 
	2 xVELOCITY abs 0.01 < 
	0 
	counter 10 > IF
;
				
:RotatePosition
	lap 4095 * 2 xANGLE + -->totalAngle
	-->targetAngle
	100 motorDirection * -1 * 2 -->xMOTOR
;				
				
+--------------------------------------------------------------------+
| Helper Functions
+--------------------------------------------------------------------+			
				
:IF -->f f ! * swap f * + ;		
		     
:! 0 = ;

:DegreeToBit
	0.002779 * 4095 *
;

:BitToDegree
	0.000246548 * 360 *
;

:TOTAL_ANGLE
	4096 lap * 2 xANGLE + 
;

:FingerToMotorAngle
	1 + 2 * 
; 
